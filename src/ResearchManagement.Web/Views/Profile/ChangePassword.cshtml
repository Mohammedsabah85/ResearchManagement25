@* @model ResearchManagement.Web.Models.ViewModels.Profile.ChangePasswordViewModel
@{
    ViewData["Title"] = "تغيير كلمة المرور";
    Layout = "~/Views/Shared/_LayoutNew.cshtml";
}

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="fas fa-key me-2 text-primary"></i>تغيير كلمة المرور</h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a asp-action="Index">الملف الشخصي</a></li>
                        <li class="breadcrumb-item active">تغيير كلمة المرور</li>
                    </ol>
                </nav>
            </div>
            <div>
                <a asp-action="Index" class="btn btn-secondary">
                    <i class="fas fa-arrow-right me-1"></i>العودة للملف الشخصي
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-xl-6 col-lg-8 col-md-10">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>تحديث كلمة المرور</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>إرشادات الأمان:</strong>
                    <ul class="mb-0 mt-2">
                        <li>استخدم كلمة مرور قوية تحتوي على أحرف كبيرة وصغيرة وأرقام</li>
                        <li>تجنب استخدام معلومات شخصية سهلة التخمين</li>
                        <li>لا تشارك كلمة المرور مع أي شخص آخر</li>
                    </ul>
                </div>

                <form asp-action="ChangePassword" method="post" id="changePasswordForm" novalidate>
                    @Html.AntiForgeryToken()
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                    <div class="mb-4">
                        <label asp-for="CurrentPassword" class="form-label required">كلمة المرور الحالية</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-lock"></i></span>
                            <input asp-for="CurrentPassword" type="password" class="form-control" placeholder="أدخل كلمة المرور الحالية" />
                            <button type="button" class="btn btn-outline-secondary" id="toggleCurrentPassword" title="إظهار/إخفاء كلمة المرور">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <span asp-validation-for="CurrentPassword" class="text-danger"></span>
                    </div>

                    <div class="mb-4">
                        <label asp-for="NewPassword" class="form-label required">كلمة المرور الجديدة</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-key"></i></span>
                            <input asp-for="NewPassword" type="password" class="form-control" placeholder="أدخل كلمة مرور جديدة قوية" />
                            <button type="button" class="btn btn-outline-secondary" id="generatePassword" title="إنشاء كلمة مرور قوية">
                                <i class="fas fa-random"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="toggleNewPassword" title="إظهار/إخفاء كلمة المرور">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <span asp-validation-for="NewPassword" class="text-danger"></span>
                        <div class="password-strength mt-2" id="passwordStrength"></div>
                        <div class="form-text">
                            كلمة المرور يجب أن تحتوي على 6 أحرف على الأقل مع أرقام وأحرف كبيرة وصغيرة
                        </div>
                    </div>

                    <div class="mb-4">
                        <label asp-for="ConfirmPassword" class="form-label required">تأكيد كلمة المرور الجديدة</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-check-double"></i></span>
                            <input asp-for="ConfirmPassword" type="password" class="form-control" placeholder="أعد إدخال كلمة المرور الجديدة" />
                            <button type="button" class="btn btn-outline-secondary" id="toggleConfirmPassword" title="إظهار/إخفاء كلمة المرور">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                        <div id="passwordMatch" class="form-text"></div>
                    </div>

                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <h6 class="card-title"><i class="fas fa-lightbulb me-2 text-warning"></i>نصائح لكلمة مرور قوية</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="fas fa-check text-success me-2"></i>8 أحرف على الأقل</li>
                                        <li><i class="fas fa-check text-success me-2"></i>أحرف كبيرة وصغيرة</li>
                                        <li><i class="fas fa-check text-success me-2"></i>أرقام ورموز خاصة</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="fas fa-times text-danger me-2"></i>تجنب التواريخ الشخصية</li>
                                        <li><i class="fas fa-times text-danger me-2"></i>تجنب الكلمات الشائعة</li>
                                        <li><i class="fas fa-times text-danger me-2"></i>لا تكرر نفس كلمة المرور</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                        <a asp-action="Index" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>إلغاء
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-save me-2"></i>حفظ كلمة المرور الجديدة
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts
{
    <script type="text/javascript">
        function initializePasswordForm() {
            $(document).ready(function() {
                $('#NewPassword').on('input', function() {
                    updatePasswordStrength($(this).val());
                    checkPasswordMatch();
                });

                $('#ConfirmPassword').on('input', function() {
                    checkPasswordMatch();
                });

                $('#toggleCurrentPassword').click(function() {
                    togglePasswordVisibility('#CurrentPassword', this);
                });

                $('#toggleNewPassword').click(function() {
                    togglePasswordVisibility('#NewPassword', this);
                });

                $('#toggleConfirmPassword').click(function() {
                    togglePasswordVisibility('#ConfirmPassword', this);
                });

                $('#generatePassword').click(function() {
                    var newPassword = generateStrongPassword();
                    $('#NewPassword').val(newPassword);
                    $('#ConfirmPassword').val(newPassword);
                    updatePasswordStrength(newPassword);
                    checkPasswordMatch();
                    showNotification('تم إنشاء كلمة مرور قوية', 'success');
                });

                $('#changePasswordForm').on('submit', function(e) {
                    if (!validateForm()) {
                        e.preventDefault();
                        showNotification('يرجى تصحيح الأخطاء المطلوبة', 'error');
                        scrollToFirstError();
                    } else {
                        $('#submitBtn').html('<i class="fas fa-spinner fa-spin me-2"></i>جار الحفظ...').prop('disabled', true);
                    }
                });

                $('#changePasswordForm input').on('blur', function() {
                    validateField($(this));
                });

                $('#changePasswordForm input').on('input', function() {
                    clearFieldError($(this));
                });
            });
        }

        function updatePasswordStrength(password) {
            var strength = calculatePasswordStrength(password);
            var strengthIndicator = $('#passwordStrength');
            
            if (!password) {
                strengthIndicator.html('');
                return;
            }

            var strengthTexts = ['ضعيفة', 'متوسطة', 'جيدة', 'قوية'];
            var strengthColors = ['danger', 'warning', 'info', 'success'];
            var progressWidth = (strength.level + 1) * 25;
            var strengthText = strengthTexts[strength.level];
            var strengthColor = strengthColors[strength.level];

            strengthIndicator.html(
                '<div class="progress mb-1" style="height: 6px;">' +
                    '<div class="progress-bar bg-' + strengthColor + '" style="width: ' + progressWidth + '%"></div>' +
                '</div>' +
                '<small class="text-' + strengthColor + '">' +
                    'قوة كلمة المرور: ' + strengthText +
                '</small>'
            );
        }

        function calculatePasswordStrength(password) {
            var score = 0;
            var checks = [
                password.length >= 8,
                /[a-z]/.test(password),
                /[A-Z]/.test(password),
                /[0-9]/.test(password),
                /[^A-Za-z0-9]/.test(password)
            ];

            for (var i = 0; i < checks.length; i++) {
                if (checks[i]) score++;
            }
            
            return {
                level: Math.min(3, Math.max(0, score - 1)),
                score: score
            };
        }

        function checkPasswordMatch() {
            var newPassword = $('#NewPassword').val();
            var confirmPassword = $('#ConfirmPassword').val();
            var matchIndicator = $('#passwordMatch');

            if (!confirmPassword) {
                matchIndicator.html('');
                return;
            }

            if (newPassword === confirmPassword) {
                matchIndicator.html('<small class="text-success"><i class="fas fa-check me-1"></i>كلمة المرور متطابقة</small>');
                clearFieldError($('#ConfirmPassword'));
            } else {
                matchIndicator.html('<small class="text-danger"><i class="fas fa-times me-1"></i>كلمة المرور غير متطابقة</small>');
                showFieldError($('#ConfirmPassword'), 'كلمة المرور غير متطابقة');
            }
        }

        function togglePasswordVisibility(fieldSelector, button) {
            var field = $(fieldSelector);
            var icon = $(button).find('i');

            if (field.attr('type') === 'password') {
                field.attr('type', 'text');
                icon.removeClass('fa-eye').addClass('fa-eye-slash');
            } else {
                field.attr('type', 'password');
                icon.removeClass('fa-eye-slash').addClass('fa-eye');
            }
        }

        function generateStrongPassword(length) {
            length = length || 12;
            var charset = {
                lowercase: 'abcdefghijklmnopqrstuvwxyz',
                uppercase: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
                numbers: '0123456789',
                symbols: '!@#$%^&*'
            };

            var allChars = charset.lowercase + charset.uppercase + charset.numbers + charset.symbols;
            var password = '';

            // ضمان وجود حرف واحد على الأقل من كل نوع
            password += charset.lowercase[Math.floor(Math.random() * charset.lowercase.length)];
            password += charset.uppercase[Math.floor(Math.random() * charset.uppercase.length)];
            password += charset.numbers[Math.floor(Math.random() * charset.numbers.length)];
            password += charset.symbols[Math.floor(Math.random() * charset.symbols.length)];

            // إضافة باقي الأحرف عشوائياً
            for (var i = 4; i < length; i++) {
                password += allChars[Math.floor(Math.random() * allChars.length)];
            }

            // خلط الأحرف
            return password.split('').sort(function() { return Math.random() - 0.5; }).join('');
        }

        function validateForm() {
            var isValid = true;

            $('#changePasswordForm input[type="password"]').each(function() {
                if (!validateField($(this))) {
                    isValid = false;
                }
            });

            var newPassword = $('#NewPassword').val();
            var confirmPassword = $('#ConfirmPassword').val();

            if (newPassword !== confirmPassword) {
                showFieldError($('#ConfirmPassword'), 'كلمة المرور غير متطابقة');
                isValid = false;
            }

            if (newPassword.length < 6) {
                showFieldError($('#NewPassword'), 'كلمة المرور يجب أن تحتوي على 6 أحرف على الأقل');
                isValid = false;
            }

            return isValid;
        }

        function validateField($field) {
            var value = $field.val().trim();
            
            if (!value) {
                showFieldError($field, 'هذا الحقل مطلوب');
                return false;
            }
            
            clearFieldError($field);
            return true;
        }

        function showFieldError($field, message) {
            $field.addClass('is-invalid');
            $field.siblings('.text-danger').text(message);
        }

        function clearFieldError($field) {
            $field.removeClass('is-invalid');
            $field.siblings('.text-danger').text('');
        }

        function scrollToFirstError() {
            var firstError = $('.is-invalid').first();
            if (firstError.length) {
                $('html, body').animate({
                    scrollTop: firstError.offset().top - 100
                }, 500);
                firstError.focus();
            }
        }

        function showNotification(message, type) {
            type = type || 'info';
            var alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-danger' : 
                              'alert-info';

            var iconClass = type === 'success' ? 'check-circle' : 
                             type === 'error' ? 'exclamation-circle' : 
                             'info-circle';

            var notification = $('<div class="alert ' + alertClass + ' alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">' +
                '<i class="fas fa-' + iconClass + ' me-2"></i>' + message +
                '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                '</div>');

            $('body').append(notification);

            setTimeout(function() {
                notification.fadeOut(function() {
                    $(this).remove();
                });
            }, 5000);
        }

        // تهيئة النموذج
        initializePasswordForm();
    </script>
}

@section Styles
{
    <style>
        .form-label.required::after {
            content: " *";
            color: #dc3545;
        }

        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }

        .card-header {
            background-color: rgba(0, 0, 0, 0.03);
            border-bottom: 1px solid rgba(0, 0, 0, 0.125);
        }

        .form-control:focus {
            border-color: var(--bs-primary);
            box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
        }

        .form-control.is-invalid {
            border-color: #dc3545;
            background-color: #fff5f5;
        }

        .input-group-text {
            background: linear-gradient(135deg, var(--bs-primary) 0%, #0056b3 100%);
            color: white;
            border: 2px solid var(--bs-primary);
        }

        .password-strength {
            margin-top: 5px;
        }

        .progress {
            height: 6px;
            border-radius: 3px;
        }

        .breadcrumb {
            background-color: transparent;
            padding: 0;
            margin-bottom: 0;
        }

        .breadcrumb-item + .breadcrumb-item::before {
            content: "/";
        }

        .alert {
            border-radius: 8px;
        }

        .btn:disabled {
            opacity: 0.65;
            cursor: not-allowed;
        }

        .list-unstyled li {
            margin-bottom: 0.25rem;
        }

        @@media (max-width: 768px) {
            .d-md-flex {
                flex-direction: column;
                gap: 10px;
            }
            
            .justify-content-md-between {
                text-align: center;
            }
        }
    </style>
} *@